<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <object th:include="fragments/head :: head" th:remove="tag"></object>
</head>

<body class="page-container-bg-solid" id="loadPage">
<div th:include="fragments/topmenuheader :: header"></div>
<div class="container-fluid page-body-wrapper">
    <div class= "row">
        <div class="col-md-6 mb-3" style="height: 60%;">
            <div style="margin: 10px; width: 100%;">
                <form id="search">
                    <div class="form-group">

                        <label for="fromdt">From</label>
                        <input type="datetime-local" class="form-control" id="fromdt" name="fromdt" >
                        <label for="todt">To</label>
                        <input type="datetime-local" class="form-control" id="todt" name="todt">
                    </div>

                    <button type="search" class="btn btn-primary">Search</button>
                </form>
            </div>
        </div>
    </div>
    <div class="row" id="userJourneyGraph" style="display: none;">
        <div class="col-md-12 mb-3" style="height: 60%;">
            <div class="card h-100">
                <div class="card-header">
                    <span class="me-2"><i class="bi bi-bar-chart-fill"></i></span>
                    Normal Journey
                </div>
                <div class="card-body">
                    <div id="container" style="width:100%; height:100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div></div>




<!-- <div th:include="fragments/homefooter :: footer"></div>s -->
<script th:inline="javascript">
    /*<![CDATA[*/
        var dash = document.querySelector('#dashboard');
        dash.classList.remove('active');
        var userJ = document.querySelector("#userJourney");
        userJ.classList.remove('active');
        var normalJ = document.querySelector("#normalJourney");
        normalJ.classList.add('active');
        var totime;
        var fromtime;
        if ([[${todt}]] && [[${fromdt}]]){
            totime = new Date([[${todt}]]);
            fromtime = new Date([[${fromdt}]]);
            fromtime.setMinutes(fromtime.getMinutes() - fromtime.getTimezoneOffset());
            document.getElementById("userJourneyGraph").style.display="block";
        }else{
            totime = new Date();
            fromtime = new Date();
            fromtime.setMinutes(fromtime.getMinutes() - 60 - fromtime.getTimezoneOffset());
            document.getElementById("userJourneyGraph").style.display="none";

        }
        totime.setMinutes(totime.getMinutes() - totime.getTimezoneOffset());

        document.getElementById('fromdt').value = fromtime.toISOString().slice(0,16);
        document.getElementById('todt').value = totime.toISOString().slice(0,16);


        $("#search").submit(function(e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.

            var form = $(this);
            // var url = form.attr('action');

            var fromdate = new Date(document.getElementById('fromdt').value);
            var todate = new Date(document.getElementById('todt').value);

            $.ajax({
                type: "GET",
                url: "getNormalJourney?fromdate="+Date.parse(fromdate)+"&todate="+Date.parse(todate),
                dataType: "html",
                success: function(data) {
                    $("body").html(data);
                }
            });
        });


        $(function () {
            Highcharts.setOptions({
                lang: {
                    decimalPoint: '.',
                    thousandsSep: ','
                }
            });

            drawlineChart();
        });


        function drawlineChart() {
            var page = [[${funnelPage}]];
            // var simpleJsonObject =[[${simpleJsonObject}]];
            var userJourneyLineChart = Highcharts.chart('container', {
               chart:{
                   type: 'scatter'
               },
                title: {
                        text: ''
                    },

            plotOptions: {
                series: {
                    allowPointSelect: true,
                    marker: {
                        enabled: true,
                        value: 'x'

                    }
                }
            },

            xAxis: {
                type: 'datetime',
                    labels: {
                        step: 2,
                        rotation: -45,
                        formatter: function() {
                                return Highcharts.dateFormat('%d %b %y  <br/> %H:%M ', this.value);
                        }
                    },
                    startOnTick: true,
                    endOnTick: true,
                    showLastLabel: true,
            },
            tooltip: {
                formatter: function() {
                    var chart = Highcharts.charts[0],
                        weekdays = chart.options.lang.weekdays,
                        day = new Date(this.x);

                    return day + ': ' + page[this.y];
                }
            },

                yAxis: {
                title: {
                    text: 'Funnel Page'
                },
                categories: [[${funnelPage}]]
            },

                series: [[${seriesArray}]]


            });

        }

        /*]]>*/
    </script>


</body>
</html>
